---
title: "edu-cost"
author: "Jake Weinreb"
date: "5/9/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = "/Users/jakeweinreb/Desktop/R/Data/Education/")
```

```{r libraries}
library(tidyverse)
library(janitor)
library(readr)
library(rebus)
library(googlesheets)
```

## Distance Education

```{r upload}
institution <- read_csv("institution.csv") %>% clean_names() %>% filter(instcat_hd2017 == 2)
retention_raw <- read_csv("retention.csv") %>% clean_names() %>% select(-x33) %>% 
  filter(unit_id %in% institution$unit_id) %>% 
  gather(key = full_year, value = full, contains("ret_pcf_ef")) %>% 
  gather(key = part_year, value = part, contains("ret_pcp_ef")) %>% 
  gather(key = exclusive_year, value = exclusive, contains("pctdeexc_drvef")) %>% 
  gather(key = some_year, value = some, contains("pctdesom_drvef")) %>% 
  gather(key = none_year, value = none, contains("pctdenon_drvef")) %>% 
  mutate(full_year = str_extract(full_year, "201" %R% DGT),
         part_year = str_extract(part_year, "201" %R% DGT),
         exclusive_year = str_extract(exclusive_year, "201" %R% DGT),
         some_year = str_extract(some_year, "201" %R% DGT),
         none_year = str_extract(none_year, "201" %R% DGT)) %>% #takes a while (~10 mins)
  filter(full_year == part_year, part_year == exclusive_year, exclusive_year == some_year, some_year == none_year)
```

Remote classwork has clearly become more popular over time, with the average percentage of students taking some or all remote classes rising.

```{r remote_over_time}
online_over_time <- retention_raw %>% select(full_year, exclusive, some, none) %>% group_by(full_year) %>%
  summarize(avg_exclusive = mean(exclusive, na.rm = TRUE),
            avg_some = mean(some, na.rm = TRUE),
            avg_none = mean(none, na.rm = TRUE)) %>% 
  gather(key = cat, value = avg, -full_year) 

online_over_time %>% ggplot(aes(full_year, avg, color = cat, group = cat)) + 
  geom_point() + 
  geom_line() +
  scale_color_manual(values = c("#AC2937", "#272C2F", "#808080"),
                     name = "",
                     breaks = c("avg_exclusive", "avg_some", "avg_none"),
                     labels = c("Exclusive", "Some", "None")) +
  theme_minimal() +
  scale_y_continuous(labels = function(x) str_c(x, "%")) +
  labs(x = "", y = "", title = "Average percent of students studying remotely")
```

Number of remote only has been on the rise, while the number not offering a remote option has fallen by ____%

```{r num_remote}
num_remote <- retention_raw %>% select(full_year, exclusive, none) %>% 
  filter(exclusive == 100 | none == 100) %>% 
  gather(key = cat, value = pct, -full_year) %>% 
  filter(pct == 100) %>% 
  group_by(full_year, cat) %>% 
  tally()

num_remote %>% ggplot(aes(full_year, n, fill = cat)) + geom_col(position = 'dodge')
```

I was curious if this trend will have an impact on retention rates, or if switching costs are reduced when there is no tether to the physical location of the school.  The charts below validate this intuition, at least historically.  There is a clear negative relationship between retention rate and percentage of students taking remote coursework, and the pattern is consistent across time.

```{r comparison_over_time}
retention_raw %>% ggplot(aes(x = full, y = none, group = full_year)) + geom_point(alpha = .3) + facet_wrap(~full_year)
```

This data isn't perfect, however.  It shows the percentage of students for each university that take remote classes, which could introduce bias as schools with more remote classes could have confounding factors that cause them to have lower retention.  In other words, this doesn't show whether the students leaving the school are the ones taking online classes or not.  What we would ideally want would be data on individual students at a given university and whether there is a relationship between those taking online courses and retention.

##Financial Statements


```{r financials_import}
#reading from personal drive
for_profit <- read_csv("finance_profit.csv") %>% clean_names() %>% filter(unit_id %in% institution$unit_id)
private <- bind_cols(read_csv("finance_private_current.csv"), read_csv("finance_private_historical.csv")) %>% clean_names() %>% filter(unit_id %in% institution$unit_id)
public <- bind_cols(read_csv("finance_public_current.csv"), read_csv("finance_public_historical.csv")) %>% clean_names() %>% filter(unit_id %in% institution$unit_id)
```

```{r sums}
#add up each column and transpose
add_n_transpose <- function(df){
  df %>% summarize_if(is.numeric, sum, na.rm = TRUE) %>% rename_all(~str_remove(., "_f" %R% one_or_more("[:alnum:]") %R% END)) %>% t() %>% as.data.frame %>% rownames_to_column()
}
  
for_profit_clean <- for_profit %>% add_n_transpose()
private_clean <- private %>% add_n_transpose()
public_clean <- public %>% add_n_transpose()
```

```{r sheets_export}
#have to log in if not already
gs_title("ed_financials") %>% gs_ws_new(ws_title = "for_profit", input = for_profit_clean)
gs_title("ed_financials") %>% gs_ws_new(ws_title = "private", input = private_clean)
gs_title("ed_financials") %>% gs_ws_new(ws_title = "public", input = public_clean)
```

